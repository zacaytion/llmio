# Loomio Go Rewrite: Work Breakdown Structure (WBS)

**Date:** 2026-01-29
**Status:** Proposed
**Phase:** 3 - Detailed Plan Creation

## Document Purpose

This WBS breaks down the Loomio Rails→Go rewrite into estimable work packages. Estimates use **story points** (1 SP ≈ 1 ideal developer-day) with a 40% buffer applied to all totals.

**Estimation basis:**
- Discovery Report metrics (56 tables, 53+ models, 38 workers, 30+ API controllers)
- ADR-001 hybrid migration phases
- Team Resource Plan (6.5 FTE baseline)

---

## WBS Summary

| Phase | Description | Raw SP | Buffered SP | Calendar Weeks |
|-------|-------------|--------|-------------|----------------|
| 0 | Foundation & Infrastructure | 120 | 168 | 4 |
| 1 | Channel Server Migration | 80 | 112 | 3 |
| 2 | Read-Only API Endpoints | 200 | 280 | 7 |
| 3 | Write Endpoints by Domain | 480 | 672 | 16 |
| 4 | Integration & Polish | 160 | 224 | 6 |
| 5 | Testing & Launch | 120 | 168 | 4 |
| **Total** | | **1,160** | **1,624** | **40 weeks** |

**Calendar estimate:** ~10 months with 6.5 FTE (assumes 4 SP/dev/week average)

---

## Phase 0: Foundation & Infrastructure

**Goal:** Project setup, CI/CD, core packages, database connectivity

### 0.1 Project Setup (20 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 0.1.1 | Go module initialization, directory structure | 3 | - | Follow golang-standards/project-layout |
| 0.1.2 | Configuration management (env loading) | 5 | 0.1.1 | Use caarlos0/env/v10 per ADR-003 |
| 0.1.3 | Logging setup (slog) | 3 | 0.1.1 | Structured logging with request IDs |
| 0.1.4 | Error handling patterns | 5 | 0.1.1 | Sentinel errors, wrapping, HTTP mapping |
| 0.1.5 | Makefile and development scripts | 4 | 0.1.1 | build, test, lint, migrate commands |

### 0.2 CI/CD Pipeline (25 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 0.2.1 | GitHub Actions: lint (golangci-lint) | 3 | 0.1.1 | Fail on warnings |
| 0.2.2 | GitHub Actions: unit tests | 5 | 0.1.1 | With coverage reporting |
| 0.2.3 | GitHub Actions: integration tests | 8 | 0.3.1 | testcontainers-go |
| 0.2.4 | Docker image build | 5 | 0.1.1 | Multi-stage, minimal image |
| 0.2.5 | Contract test integration | 4 | 0.2.2 | OpenAPI spec validation |

### 0.3 Database Layer (40 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 0.3.1 | pgx connection pool setup | 5 | 0.1.2 | Connection string from config |
| 0.3.2 | sqlc configuration | 8 | 0.3.1 | Handle JSONB, arrays, citext |
| 0.3.3 | Core table queries (users, groups) | 10 | 0.3.2 | First batch of generated code |
| 0.3.4 | Database migrations tooling | 8 | 0.3.1 | golang-migrate or goose |
| 0.3.5 | Transaction management patterns | 5 | 0.3.1 | Context-based transactions |
| 0.3.6 | Database test fixtures | 4 | 0.3.3 | Factory pattern for tests |

### 0.4 HTTP Server Foundation (20 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 0.4.1 | Chi router setup | 3 | 0.1.1 | Per ADR-003 |
| 0.4.2 | Middleware stack (logging, recovery, CORS) | 8 | 0.4.1, 0.1.3 | Request ID propagation |
| 0.4.3 | Health check endpoints | 2 | 0.4.1 | /health, /ready |
| 0.4.4 | Request/response helpers | 4 | 0.4.1 | JSON encoding, error responses |
| 0.4.5 | OpenAPI spec generation | 3 | 0.4.1 | swaggo or manual |

### 0.5 Background Jobs (15 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 0.5.1 | River setup | 5 | 0.3.1 | Per ADR-003, PostgreSQL-backed |
| 0.5.2 | Job registration patterns | 5 | 0.5.1 | Type-safe job definitions |
| 0.5.3 | Job monitoring/observability | 5 | 0.5.1 | River UI or custom dashboard |

**Phase 0 Total: 120 SP (168 buffered)**

---

## Phase 1: Channel Server Migration

**Goal:** Rewrite records.js and bots.js in Go (per ADR-002)

### 1.1 WebSocket Server (40 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 1.1.1 | WebSocket server setup (nhooyr.io/websocket) | 8 | 0.4.1 | Per ADR-003 |
| 1.1.2 | Room-based broadcasting | 10 | 1.1.1 | user-{id}, group-{id} rooms |
| 1.1.3 | Redis pub/sub subscription | 8 | 1.1.1 | /records channel |
| 1.1.4 | User authentication via Redis lookup | 6 | 1.1.3 | /current_users/{token} |
| 1.1.5 | Connection management (joins, reconnects) | 8 | 1.1.2 | Handle group membership changes |

### 1.2 Matrix Bot (25 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 1.2.1 | mautrix/go integration | 8 | 0.1.1 | Matrix SDK setup |
| 1.2.2 | Redis pub/sub for chatbot/* channels | 5 | 1.2.1 | Pattern subscription |
| 1.2.3 | Room resolution and message sending | 8 | 1.2.2 | HTML message support |
| 1.2.4 | Bot configuration management | 4 | 1.2.1 | Multiple bots support |

### 1.3 Channel Server Testing (15 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 1.3.1 | WebSocket integration tests | 8 | 1.1.5 | Real Redis in testcontainers |
| 1.3.2 | Load testing WebSocket connections | 5 | 1.1.5 | Benchmark vs Node.js baseline |
| 1.3.3 | Matrix bot mock tests | 2 | 1.2.3 | Mock Matrix API |

**Phase 1 Total: 80 SP (112 buffered)**

---

## Phase 2: Read-Only API Endpoints

**Goal:** Rewrite read endpoints by domain, maintaining API contract

### 2.1 Authentication Foundation (40 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 2.1.1 | JWT token generation/validation | 8 | 0.4.2 | golang-jwt/jwt/v5 |
| 2.1.2 | Session cookie handling | 8 | 2.1.1 | Rails session compatibility |
| 2.1.3 | Password hashing (bcrypt) | 3 | 0.1.1 | Import existing hashes |
| 2.1.4 | Login endpoint | 8 | 2.1.1, 2.1.3 | POST /api/v1/sessions |
| 2.1.5 | Magic link authentication | 8 | 2.1.1 | LoginToken table |
| 2.1.6 | OAuth provider integration | 5 | 2.1.1 | Identity model reading |

### 2.2 Users Domain (25 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 2.2.1 | User model and queries | 5 | 0.3.3 | 377 LOC model → sqlc |
| 2.2.2 | GET /api/v1/profile | 5 | 2.2.1, 2.1.1 | Current user endpoint |
| 2.2.3 | GET /api/v1/users/:id | 5 | 2.2.1 | User detail |
| 2.2.4 | GET /api/v1/users/search | 5 | 2.2.1 | Mentionable users search |
| 2.2.5 | User serializer (API contract) | 5 | 2.2.1 | Match Rails exactly |

### 2.3 Groups Domain (35 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 2.3.1 | Group model and queries | 8 | 0.3.3 | Hierarchical (parent_id) |
| 2.3.2 | Membership model and queries | 5 | 2.3.1 | Roles, permissions |
| 2.3.3 | GET /api/v1/groups | 8 | 2.3.1 | List with permissions |
| 2.3.4 | GET /api/v1/groups/:id | 5 | 2.3.1 | Group detail |
| 2.3.5 | GET /api/v1/groups/:id/subgroups | 4 | 2.3.1 | Tree traversal |
| 2.3.6 | Group serializer (API contract) | 5 | 2.3.1 | Match Rails exactly |

### 2.4 Discussions Domain (40 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 2.4.1 | Discussion model and queries | 8 | 0.3.3 | With templates |
| 2.4.2 | Event model and queries | 10 | 0.3.3 | **Complex:** position_key threading |
| 2.4.3 | GET /api/v1/discussions | 8 | 2.4.1, 2.3.2 | Permission-filtered list |
| 2.4.4 | GET /api/v1/discussions/:id | 5 | 2.4.1 | With timeline |
| 2.4.5 | GET /api/v1/events | 5 | 2.4.2 | Threaded events |
| 2.4.6 | Discussion/Event serializers | 4 | 2.4.1, 2.4.2 | Match Rails exactly |

### 2.5 Polls Domain (40 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 2.5.1 | Poll model and queries | 10 | 0.3.3 | Multiple poll types |
| 2.5.2 | Stance/StanceChoice models | 8 | 2.5.1 | Voting data |
| 2.5.3 | Outcome model | 4 | 2.5.1 | Decision outcomes |
| 2.5.4 | GET /api/v1/polls | 8 | 2.5.1, 2.3.2 | Permission-filtered |
| 2.5.5 | GET /api/v1/polls/:id | 5 | 2.5.1 | With stances |
| 2.5.6 | Poll serializers (all types) | 5 | 2.5.1 | Match Rails exactly |

### 2.6 Supporting Endpoints (20 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 2.6.1 | GET /api/v1/notifications | 8 | 2.2.1 | User notifications |
| 2.6.2 | GET /api/v1/memberships | 5 | 2.3.2 | User memberships |
| 2.6.3 | GET /api/v1/tags | 3 | 0.3.3 | Tag listing |
| 2.6.4 | GET /api/v1/translations | 4 | 0.3.3 | i18n support |

**Phase 2 Total: 200 SP (280 buffered)**

---

## Phase 3: Write Endpoints by Domain

**Goal:** Complete write operations, achieving feature parity

### 3.1 Permission System (60 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 3.1.1 | Extract CanCanCan rules to matrix | 15 | Phase 2 | **Risk #4 mitigation** |
| 3.1.2 | Implement permission checking | 20 | 3.1.1 | Per-action, per-resource |
| 3.1.3 | Group permission inheritance | 15 | 3.1.2 | Parent → child propagation |
| 3.1.4 | Permission test suite | 10 | 3.1.2 | Cover all endpoints |

### 3.2 Users Write Operations (30 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 3.2.1 | POST /api/v1/users (registration) | 8 | 2.1.1 | With validation |
| 3.2.2 | PUT /api/v1/profile | 8 | 2.2.2, 3.1.2 | Profile updates |
| 3.2.3 | Password change/reset | 8 | 2.1.3 | Secure flow |
| 3.2.4 | DELETE /api/v1/users/:id | 6 | 3.1.2 | Soft delete (discarded_at) |

### 3.3 Groups Write Operations (50 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 3.3.1 | POST /api/v1/groups | 10 | 2.3.1, 3.1.2 | Group creation |
| 3.3.2 | PUT /api/v1/groups/:id | 10 | 2.3.4, 3.1.2 | Settings updates |
| 3.3.3 | POST /api/v1/memberships | 10 | 2.3.2, 3.1.2 | Invitations, joins |
| 3.3.4 | PUT /api/v1/memberships/:id | 8 | 3.3.3 | Role changes |
| 3.3.5 | DELETE /api/v1/groups/:id | 8 | 3.1.2 | Archive flow |
| 3.3.6 | Subgroup management | 4 | 3.3.1 | Create under parent |

### 3.4 Discussions Write Operations (60 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 3.4.1 | POST /api/v1/discussions | 10 | 2.4.1, 3.1.2 | Start discussion |
| 3.4.2 | PUT /api/v1/discussions/:id | 8 | 2.4.4, 3.1.2 | Edit discussion |
| 3.4.3 | POST /api/v1/comments | 12 | 2.4.2 | **Complex:** Event threading |
| 3.4.4 | PUT /api/v1/comments/:id | 6 | 3.4.3 | Edit comment |
| 3.4.5 | DELETE /api/v1/comments/:id | 5 | 3.4.3 | Soft delete |
| 3.4.6 | Discussion templates | 8 | 3.4.1 | Create from template |
| 3.4.7 | Event position_key generation | 11 | 3.4.3 | **Risk #3 mitigation** |

### 3.5 Polls Write Operations (80 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 3.5.1 | POST /api/v1/polls | 15 | 2.5.1, 3.1.2 | Create poll (all types) |
| 3.5.2 | PUT /api/v1/polls/:id | 10 | 2.5.5 | Edit poll |
| 3.5.3 | POST /api/v1/stances | 20 | 2.5.2 | **Complex:** Voting logic per poll type |
| 3.5.4 | Voting algorithm tests | 15 | 3.5.3 | Property-based tests |
| 3.5.5 | POST /api/v1/outcomes | 10 | 2.5.3 | Record decision |
| 3.5.6 | Poll close/reopen | 5 | 3.5.1 | Status transitions |
| 3.5.7 | Poll templates | 5 | 3.5.1 | Create from template |

### 3.6 Notifications (40 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 3.6.1 | Notification generation | 15 | 3.4.3, 3.5.3 | On events |
| 3.6.2 | In-app notification delivery | 8 | 3.6.1 | WebSocket push |
| 3.6.3 | Notification preferences | 8 | 3.6.1 | User settings |
| 3.6.4 | Mark read/unread operations | 5 | 3.6.1 | Bulk operations |
| 3.6.5 | Digest compilation | 4 | 3.6.1 | For email digests |

### 3.7 Email System (50 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 3.7.1 | Email template system | 10 | 0.5.1 | HTML templates |
| 3.7.2 | Transactional emails | 10 | 3.7.1 | Verification, password reset |
| 3.7.3 | Notification emails | 10 | 3.6.1, 3.7.1 | Event-based |
| 3.7.4 | Email digest worker | 8 | 3.6.5, 3.7.1 | Daily/weekly digests |
| 3.7.5 | Inbound email parsing | 12 | 3.4.3 | **Risk #8:** ActionMailbox replacement |

### 3.8 File Handling (40 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 3.8.1 | ActiveStorage-compatible uploads | 15 | 0.4.1 | S3/GCS support |
| 3.8.2 | Image processing | 10 | 3.8.1 | Thumbnails, avatars |
| 3.8.3 | Attachment model and queries | 8 | 3.8.1 | Polymorphic |
| 3.8.4 | Document attachments to discussions | 7 | 3.8.3, 3.4.1 | Upload flow |

### 3.9 Search (30 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 3.9.1 | PostgreSQL full-text search setup | 10 | 0.3.2 | tsvector columns |
| 3.9.2 | GET /api/v1/search | 12 | 3.9.1 | Global search |
| 3.9.3 | Scoped search (within group/discussion) | 8 | 3.9.2 | Permission-aware |

### 3.10 SAML/SSO (40 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 3.10.1 | SAML SP implementation | 20 | 2.1.1 | **Risk #16:** Complex |
| 3.10.2 | OAuth providers (Google, Facebook, etc.) | 12 | 2.1.6 | Expand Identity model |
| 3.10.3 | SSO test suite | 8 | 3.10.1 | Mock IdP testing |

**Phase 3 Total: 480 SP (672 buffered)**

---

## Phase 4: Integration & Polish

**Goal:** Frontend integration, data migration, optimization

### 4.1 Frontend Integration (40 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 4.1.1 | API contract verification (all endpoints) | 15 | Phase 3 | JSON diff testing |
| 4.1.2 | Fix serializer discrepancies | 15 | 4.1.1 | **Risk #2 mitigation** |
| 4.1.3 | WebSocket protocol compatibility | 5 | 1.1.5 | Vue Socket.io client |
| 4.1.4 | E2E test suite | 5 | 4.1.1 | Playwright or similar |

### 4.2 Data Migration (50 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 4.2.1 | Migration script development | 15 | Phase 3 | **Risk #1 mitigation** |
| 4.2.2 | Data validation suite | 15 | 4.2.1 | All 56 tables |
| 4.2.3 | Migration dry run on prod copy | 10 | 4.2.1 | Timing, issues |
| 4.2.4 | Rollback procedures | 10 | 4.2.1 | Document and test |

### 4.3 Performance Optimization (40 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 4.3.1 | Query optimization (N+1 fixes) | 15 | Phase 3 | Profile heavy endpoints |
| 4.3.2 | Caching layer (Redis) | 10 | 4.3.1 | Session, frequent queries |
| 4.3.3 | Load testing | 10 | 4.3.2 | k6 baseline comparison |
| 4.3.4 | Memory profiling | 5 | 4.3.1 | pprof analysis |

### 4.4 Security Hardening (30 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 4.4.1 | Security audit | 15 | Phase 3 | OWASP checklist |
| 4.4.2 | Rate limiting | 8 | 0.4.2 | Per-endpoint limits |
| 4.4.3 | Input validation review | 7 | Phase 3 | All endpoints |

**Phase 4 Total: 160 SP (224 buffered)**

---

## Phase 5: Testing & Launch

**Goal:** Beta deployment, production migration

### 5.1 Beta Deployment (40 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 5.1.1 | Shadow mode deployment | 10 | Phase 4 | Per Deployment Plan |
| 5.1.2 | Shadow traffic analysis | 10 | 5.1.1 | Response comparison |
| 5.1.3 | Canary deployment (1% traffic) | 10 | 5.1.2 | Monitoring setup |
| 5.1.4 | Beta user feedback collection | 10 | 5.1.3 | Issue tracking |

### 5.2 Production Migration (50 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 5.2.1 | Gradual rollout (1%→10%→50%→100%) | 15 | 5.1.4 | Per Deployment Plan |
| 5.2.2 | Monitoring dashboard | 10 | 5.2.1 | Rails vs Go comparison |
| 5.2.3 | On-call runbook | 10 | 5.2.1 | Incident response |
| 5.2.4 | Rails sunset verification | 10 | 5.2.1 | No traffic, data verified |
| 5.2.5 | Final cutover | 5 | 5.2.4 | Remove Rails containers |

### 5.3 Documentation (30 SP)

| ID | Task | SP | Dependencies | Notes |
|----|------|----|--------------| ------|
| 5.3.1 | API documentation (OpenAPI) | 10 | Phase 4 | All endpoints |
| 5.3.2 | Deployment runbook | 8 | 5.2.3 | For self-hosted users |
| 5.3.3 | Developer setup guide | 5 | Phase 4 | Contributing guide |
| 5.3.4 | Architecture documentation | 7 | Phase 4 | ADR updates |

**Phase 5 Total: 120 SP (168 buffered)**

---

## Critical Path

The following items are on the critical path and cannot be parallelized:

```
0.3 Database Layer
    ↓
2.1 Authentication Foundation
    ↓
3.1 Permission System
    ↓
3.4.3 POST /api/v1/comments (Event threading)
    ↓
4.1.1 API Contract Verification
    ↓
5.1.1 Shadow Mode Deployment
```

**Critical path duration:** ~28 weeks (with full team parallelizing other work)

---

## Risk-Linked Work Items

| Risk (from Risk Register) | Mitigation Work Items |
|---------------------------|----------------------|
| Risk #1: Data Migration Failure | 4.2.1, 4.2.2, 4.2.3, 4.2.4 |
| Risk #2: API Contract Drift | 4.1.1, 4.1.2, all serializer tasks |
| Risk #3: Event Threading Logic | 2.4.2, 3.4.3, 3.4.7 |
| Risk #4: Permission System Gaps | 3.1.1, 3.1.2, 3.1.3, 3.1.4 |
| Risk #5: Real-time Degradation | 1.1.*, 1.3.2 |
| Risk #6: Team Go Learning Curve | Phase 0 (all foundation work) |
| Risk #8: Email Integration | 3.7.5 |
| Risk #9: Timeline Overrun | 40% buffer on all estimates |

---

## Appendix A: Estimation Assumptions

1. **Story point definition:** 1 SP = 1 ideal developer-day
2. **Team capacity:** 6.5 FTE × 4 SP/week = 26 SP/week team velocity
3. **Buffer:** 40% added to raw estimates for unknowns
4. **Parallelization:** Assumed 70% parallelizable work across team
5. **Context switching:** Not explicitly estimated; absorbed in buffer

## Appendix B: Glossary

- **SP:** Story Points
- **FTE:** Full-Time Equivalent
- **CRDT:** Conflict-free Replicated Data Type (Y.js)
- **SSO:** Single Sign-On
- **SAML:** Security Assertion Markup Language
